%%%-------------------------------------------------------------------
%%% @author ndyumin
%%% @copyright (C) 2016, <COMPANY>
%%% @doc
%%%
%%% @end
%%% Created : 11. Янв. 2016 18:17
%%%-------------------------------------------------------------------
-module(map).
-author("ndyumin").

%% API
-export([start/0, stop/0]).

%% 140 bonus (former 4)
%% 299 (former 0)
%% 230 (former 3)
get_initial() ->
  from_matrix([
    [202, 200, 200, 200, 200, 200, 200, 200, 200, 210, 200, 200, 200, 200, 200, 200, 200, 200, 203],
    [201, 100, 100, 100, 100, 100, 100, 100, 100, 201, 100, 100, 100, 100, 100, 100, 100, 100, 201],
    [201, 140, 202, 203, 100, 202, 200, 203, 100, 201, 100, 202, 200, 203, 100, 202, 203, 140, 201],
    [201, 100, 204, 205, 100, 204, 200, 205, 100, 206, 100, 204, 200, 205, 100, 204, 205, 100, 201],
    [201, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 201],
    [201, 100, 209, 208, 100, 207, 100, 209, 200, 210, 200, 208, 100, 207, 100, 209, 208, 100, 201],
    [201, 100, 100, 100, 100, 201, 100, 100, 100, 201, 100, 100, 100, 201, 100, 100, 100, 100, 201],
    [204, 200, 200, 203, 100, 213, 200, 200, 100, 206, 100, 209, 200, 212, 100, 202, 200, 200, 205],
    [230, 230, 230, 201, 100, 201, 100, 100, 100, 100, 100, 100, 100, 201, 100, 201, 230, 230, 230],
    [200, 200, 200, 205, 100, 206, 100, 202, 208, 230, 209, 203, 100, 206, 100, 204, 200, 200, 200],
    [299, 299, 299, 299, 100, 100, 100, 201, 230, 230, 230, 201, 100, 100, 100, 299, 299, 299, 299],
    [200, 200, 200, 203, 100, 207, 100, 204, 200, 200, 200, 205, 100, 207, 100, 202, 200, 200, 200],
    [230, 230, 230, 201, 100, 201, 100, 100, 100, 299, 100, 100, 100, 201, 100, 201, 230, 230, 230],
    [202, 200, 200, 205, 100, 206, 100, 200, 200, 210, 200, 200, 100, 206, 100, 204, 200, 200, 203],
    [201, 100, 100, 100, 100, 100, 100, 100, 100, 201, 100, 100, 100, 100, 100, 100, 100, 100, 201],
    [201, 100, 209, 203, 100, 209, 200, 200, 100, 206, 100, 200, 200, 208, 100, 202, 208, 100, 201],
    [201, 140, 100, 201, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 201, 100, 140, 201],
    [213, 208, 100, 206, 100, 207, 100, 200, 200, 210, 200, 200, 100, 207, 100, 206, 100, 209, 212],
    [201, 100, 100, 100, 100, 201, 100, 100, 100, 201, 100, 100, 100, 201, 100, 100, 100, 100, 201],
    [201, 100, 200, 200, 200, 211, 200, 200, 100, 206, 100, 200, 200, 211, 200, 200, 208, 100, 201],
    [201, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 201],
    [204, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 205]
  ]).

-define(SPAWN_POSITION, {9, 12}).

from_matrix(Matrix) ->
  Lines = lists:map(fun(Line) -> array:from_list(Line) end, Matrix),
  array:from_list(Lines).

to_matrix(Array) ->
  Lines = array:to_list(Array),
  lists:map(fun(Line) -> array:to_list(Line) end, Lines).

set(X, Y, Value, Map) ->
  array:set(Y, array:set(X, Value, array:get(Y, Map)), Map).

start() ->
  MapLoop = spawn(fun() -> map_update_loop(get_initial(), false) end),
  gproc:reg_other({r, l, map}, MapLoop).

stop() ->
  erlang:error(not_implemented).

map_update_loop(Map, Update) ->
  case Update of
    true ->
      gproc:send({r, l, messenger}, {sendout_map});
    _ -> ok
  end,
  receive
    {get, Clb} ->
      Clb(to_matrix(Map)),
      map_update_loop(Map, false);

    {get_at, {X, Y},  Clb} ->
      Clb(array:get(X, array:get(Y, Map))),
      map_update_loop(Map, false);

    {get_spawn_position, Clb} ->
      Clb(?SPAWN_POSITION),
      map_update_loop(Map, false);

    {set, {X, Y}, Value} ->
      map_update_loop(set(X, Y, Value, Map), true)
  end.